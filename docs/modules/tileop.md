# tile-op

**`tile-op` provides utilities to view and manipulate the tiled data files** created by `punkst pixel-decode` or `punkst pts2tiles`.

## Available Operations

- inspecting the index

- converting binary tiled files to TSV

- reorganizing fragmented tiles to a regular grid

- merging multiple inference results

- annotating (tiled) point level file with inference results

- compute joint probability distributions of factors

- compute confusion matrix among factors at a given resolution

- denoise and keep only the top predicted factor per pixel

- aggregate pixel level inference results by cell and subcellular compartments based in transcript/pixel level annotations

- compute global connected components per label with centroid and coordinate range

- profile shell occupancy and directional surface distance between labels

(Except for printing the index, all operations are intended to be used separately)

## Usage

### Main input & output
The main input are the tiled pixel level files created by `punkst pixel-decode`, either in the custom binary format or in plain TSV format.

You can specify the pair of data and index files using `--in-data` and `--in-index`, or specify the prefix using `--in`.
When using `--in`, without `--binary`, the tool assumes the data file is `<in>.tsv` and the index file is `<in>.index`, and with `--binary` it assumes the data file is `<in>.bin` and the index file is `<in>.index`.

Use `--out` to specify the output prefix. In some operations use `--binary-out` to specify that the output is to be written in binary format.

### Basic Inspection and Conversion

To inspect the index of a tiled file:

```bash
punkst tile-op --print-index --in path/prefix [--binary]
```

To dump a binary tiled file to a plain TSV file:

```bash
punkst tile-op --dump-tsv --in path/prefix --binary --out path/prefix.dump
```

The output include `path/prefix.dump.tsv` and `path/prefix.dump.index`.

### Fix fragmented Tiles

The output of `punkst pixel-decode` is organized into non-overlapping rectangular tiles that jointly cover the entire space, but the tiles do not fit into a regular grid.

If we would need to merge multiple sets of inference results or want to join the inference results with point level data, currently we have to reorganize the data to a regular grid first. (The tile size shoud be already stored in the input's index file (`path/prefix.index`), currently we don't support generic reorganization)

Note that this is **not** required for visualization `draw-pixel-factors`.

```bash
punkst tile-op --reorganize --in path/prefix [--binary] --out path/reorg_prefix [--binary-out]
```

`--binary-out` - (Optional) Write reorganized output in binary format (`.bin`) instead of TSV (`.tsv`).

### Merge Multiple Inference Results

You can merge multiple inference files (e.g., from different models) into a single file. This finds the intersection of tiles and concatenates the results ((factor, probability) pairs) for each pixel.

```bash
punkst tile-op --in path/result1 [--binary] \
  --merge-emb path/result2.tsv path/result3.bin --k2keep 3 1 2 \
  --out path/merged_result --binary-out
```

`--merge-emb` - One or more other inference files (created by `pixel-decode`) to merge with the main input file. They can be in either TSV or binary format, but have to have proper index files stored ad `<prefix>.index`.

`--k2keep` - (Optional) A list of integers specifying how many top factors to keep from each source file (including the main input). If not provided, all factors are kept.

`--binary-out` - (Optional) Save merged or reorganized output in binary format instead of TSV.

In the above example, from file `result1.bin` (or `.tsv`) we keep top 3 factors, from `result2.tsv` we keep top 1 factor, and from `result3.bin` we keep top 2 factors. If the specified number exceeds the number of factors available in the corresponding file, all factors in the file are kept.

### Annotate Points with Inference Results

You can annotate a transcript file with the inference results. The query file is required to be generated by `punkst pts2tiles` with the same tile structure as the result file so that the tool can efficiently join it with the inference results, but you can apply `pts2tiles` to any tsv file that contains X, Y coordinates as two of its columns.

```bash
punkst tile-op --in path/prefix [--binary] \
  --annotate-pts path/transcripts --icol-x 0 --icol-y 1 \
  --out path/merged
```

`--annotate-pts` - Prefix of the points file (the tool expects `<prefix>.tsv` and `<prefix>.index`) to be annotated.

`--icol-x` - 0-based column index for X coordinate in the points file.

`--icol-y` - 0-based column index for Y coordinate in the points file.

### Compute Joint Probability Distributions

You can compute the correlations or co-occurrences between factors, either from a single model or between inference results from multiple models applied to the same dataset. This is approximated by the sum of products of posterior probabilities across all pixels, although for each pixel only the top-K factors are considered (those stored in the inference result file).
To compute co-occurrence between factors in a single model at different spatial resolutions, see the confusion matrix operation below.


#### Single Input

For a single inference result file:

```bash
punkst tile-op --prob-dot --in path/result [--binary] --out path/out_prefix
```
Output:

- `path/out_prefix.marginal.tsv`: Marginal sums of posterior probabilities for each factor.

- `path/out_prefix.joint.tsv`: Sum of products for each pair of factors.

If the file contains multiple sets of results (e.g. a merged), the output is the same as the multi-input case below, where it stores marginal and within-model joint output for each source separately, and produces cross-source products (e.g., `path/out_prefix.0v1.cross.tsv`).

#### Merging and Computing on the Fly

You can also compute these statistics while merging multiple inference result files on the fly, without writing the large merged file to disk.

```bash
punkst tile-op --prob-dot --in path/result1 [--binary] \
  --merge-emb path/result2.tsv path/result3.bin \
  --out path/out_prefix
```

This supports `--k2keep` to reduce the number of top-K factors used in each source before computing the products.

Output:

- `path/out_prefix.0.marginal.tsv`, `path/out_prefix.1.marginal.tsv`, ... (one per input source)

- `path/out_prefix.0.joint.tsv`, ... (internal dot products for each source)

- `path/out_prefix.0v1.cross.tsv`, `path/out_prefix.0v2.cross.tsv`, ... (cross-source dot products with `log10pval` from a naive chi-squared 2x2 enrichment test)

### Compute Confusion Matrix

This operation computes a confusion matrix of factors at a given spatial resolution. It divides the space into squares of a specified size, identifies the top factor for each square, and then builds a matrix of co-occurrences.

```bash
punkst tile-op --confusion 10 --in path/result [--binary] --out path/out_prefix
```

`--confusion` - The resolution (side length of square bins in microns) for computing the confusion matrix.

Output:

- `path/out_prefix.confusion.tsv`: A matrix of co-occurrence counts between factors.

### Aggregate Results by Cell

This operation aggregates pixel-level inference results at cell and subcellular compartment level, based on the tailed transcript file that contains cell/compartment annotations per transcript/pixel.
If your data is from CosMx, Xenium, or Visium MERSCOPE, you should have run `punkst pts2tiles` on the raw transcript file which contains cell ID and possibly a column indicating if the transcript is nuclear or cytoplasmic. Then the tailed file already contains the necessary information.

```bash
punkst tile-op --annotate-cell --in path/result [--binary] \
  --annotate-pts path/transcripts_with_cells \
  --icol-x 0 --icol-y 1 --icol-c 5 --icol-s 6 \
  --out path/cellular_results
```

This command will summarize the factors for each cell ID found in `path/transcripts_with_cells.tsv`.

`--annotate-cell` - Flag to enable aggregation by cell.

`--annotate-pts` - Prefix of the points file (e.g. transcripts) containing cell annotations.

`--icol-x`, `--icol-y` - 0-based column indices for X and Y coordinates.

`--icol-z` - (Optional) 0-based column index for Z coordinate.

`--icol-c` - 0-based column index for the cell ID.

`--icol-s` - (Optional) 0-based column index for subcellular component annotations. If provided, results will be aggregated per-cell and per-component.

`--k-out` - (Optional) Number of top factors to include in the output for each cell/component. If not provided, the same number of in the input file is used.

`--max-cell-diameter` - (Optional) The maximum expected diameter of a cell in microns. Used for avoiding boundary effects as we process by tiles. Default is 50.

Output:

A TSV file `path/cellular_results.tsv` containing aggregated factor probabilities for each cell (and component, if specified).

A TSV file `path/cellular_results.pseudobulk.tsv` containing the sum of factor probabilities across each subcellular component. Useful for comparing global factor abundance between components.

### Denoise Top Labels

This is a heuristic denoising operation on the top-predicted factor labels for each pixel. It replace pixels where the predicted factor differs from most of its neighbors with the majority vote among its neighbors.
It is meant for the case where you projected categorical cell types at high resolution data where you do not expect to see much mixing of cell types at single pixel level.
The output is a new tiled data file where for each pixel, only the smoothed top factor is kept. (The output can be used as input for `tile-op`, so you can dump it to a tsv file or do other operations)

```bash
punkst tile-op --smooth-top-labels 2 --in path/result [--binary] --out path/smoothed_result
```

`--smooth-top-labels` - The number of rounds to perform the denoising operation. A value greater than 0 enables the operation. One or two rounds is usually sufficient.

Optional:

`fill-empty-islands` - fill isolated empty pixels if they are surrounded by consistent neighbors. Default is to leave empty pixels unchanged. This may be helpful if you would like to get statistics like area and perimeter/edge per cell type later using `tile-op --spatial-metrics`

### Compute basic spatial metrics

This is more interpretable for cell type/cluster projection (so the labels are categorical). It is recommended to denoise and fill in scattered empty pixels first with `tile-op --smooth-top-labels r --fill-empty-islands` (see above).

```bash
punkst tile-op --smooth-top-labels 2 --in path/result [--binary] --out path/prefix --spatial-metrics
```

The output includes two files:

- `path/prefix.stats.single.tsv` for per-channel (factor or cell type) metrics. Columns are:
  - channel index (`#k`)
  - total number of pixels (`area`)
  - length of all boundaries shared with non-background pixels from other channels (`perim`)
  - length of boundaries shared with background pixels (`perim_bg`)

- `path/prefix.stats.pairwise.tsv` for pairwise metrics between channels. Let the areas and non-boundary perimeters a pair of channels be $A_k, P_k, A_l, P_l$, the columns are
  - channel indices for the pair (`#k`, `l`)
  - length of shared boundary $L_{kl}$ (`contact`)
  - $L_{kl} / (P_k + P_l - L_{kl})$ (`frac0`)
  - $L_{kl} / P_k$ (`frac1`)
  - $L_{kl} / P_l$ (`frac2`)
  - $L_{kl} / (A_k + A_l)$ (`density`)

### Connected Components

Compute global connected components for each label (4-neighborhood on raster pixels), merged across tile boundaries.

```bash
punkst tile-op --connected-components --in path/result [--binary] \
  --cc-min-size 25 --out path/out_prefix
```

`--connected-components` - run connected component profiling.

`--cc-min-size` - minimum component size to report in the main component table (histogram still includes all sizes).

Output:

- `path/out_prefix.connected_components.tsv`: one row per reported component with columns
  - label index (`#k`)
  - component rank within label by descending size (`cc_idx`)
  - component size in pixels (`size`)
  - centroid in pixel coordinates (`centroid_x`, `centroid_y`)
  - inclusive coordinate range (`xmin`, `xmax`, `ymin`, `ymax`)

- `path/out_prefix.connected_components_hist.tsv`: size histogram for all components with columns
  - label index (`#k`)
  - component size (`size`)
  - number of components with that size (`n_components`)

### Shell and Surface Profiles

Profile pairwise spatial proximity between labels using boundary-seeded distance transforms.

```bash
punkst tile-op --shell-surface --in path/result [--binary] \
  --shell-radii 5 10 20 --surface-dmax 25 \
  --cc-min-size 25 --spatial-min-pix-per-tile-label 20 \
  --out path/out_prefix
```

`--shell-surface` - run shell occupancy and surface distance profiling.

`--shell-radii` - one or more shell radii (pixels) for occupancy reporting.

`--surface-dmax` - maximum distance bin for the surface-distance histogram.

`--cc-min-size` - minimum connected-component size used for boundary seed filtering.

`--spatial-min-pix-per-tile-label` - require at least this many pixels of a label within a tile before that tile contributes seeds for the label.

Output:

- `path/out_prefix.shell.tsv`: shell occupancy summary with columns
  - focal label (`#K_focal`)
  - other label (`K2`)
  - radius (`r`)
  - number of `K2` pixels within distance `r` from boundary of focal label (`n_within`)
  - total number of `K2` pixels (`n_K2_total`)

- `path/out_prefix.surface.tsv`: directional surface-distance histogram with columns
  - source label (`#from_K1`)
  - target label (`to_K2`)
  - distance bin (`d`)
  - count (`count`)
